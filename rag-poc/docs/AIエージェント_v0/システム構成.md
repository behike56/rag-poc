# システム構成

## 技術要素

Python
AWS Lambda
AWS API Gateway
Markdown
OpenAI Vector Store
Cursor(MCPクライアント)

## 構成

- UI：開発者の Cursor
  - MCP経由でツール呼び出し（例：rag.search_and_answer / rag.ingest_markdown）
  - MCPからAPI GatewayのエンドポイントをHTTP経由で呼び出し
- API Gateway：
  - `search_and_answer` / `ingest_markdown` 用のエンドポイントを定義
  - 各エンドポイントから対応する Lambda 関数を起動
- Lambda (Python)：
  - search_and_answer：Markdown群からRAG回答
  - ingest_markdown：MarkdownテキストをOpenAI Vector Storeに登録
- OpenAI側：
  - Embeddings + Vector Store + Chat Completions
- Markdownは：
  - Gitリポジトリにある


## 疎通確認の前提条件

### 1. OpenAI / Vector Store 側
- OpenAI API キーが発行済みであること（`OPENAI_API_KEY`）
- RAG 用の Vector Store が 1 つ作成済みであること
  - Vector Store ID を控えておく
  - 利用する Embeddings モデルを決めておく（例：`text-embedding-3-small`）

### 2. AWS 側（Lambda / API Gateway）
- Lambda 関数が 2 つ作成済みであること
  - `search_and_answer`
  - `ingest_markdown`
- 各 Lambda に以下が設定されていること
  - ランタイム：Python（例：3.11）
  - 環境変数：
    - `OPENAI_API_KEY`
    - `VECTOR_STORE_ID`
    - `EMBEDDING_MODEL`（任意、固定ならコードに直書きでも可）
  - CloudWatch Logs に書き込める IAM ロール
  - インターネットアクセス（NAT / パブリックなど）
- API Gateway が作成されていること（HTTP API または REST API）
  - エンドポイント例：
    - `POST /search_and_answer` → Lambda `search_and_answer` に統合
    - `POST /ingest_markdown` → Lambda `ingest_markdown` に統合
  - 必要に応じて認証方式を決定（API Key / IAM / 無し など）

### 3. Cursor（MCP クライアント）側
- Cursor で MCP が有効になっていること
- MCP 設定ファイルに、次の 2 つのツール定義があること
  - `rag.search_and_answer`：API Gateway の `/search_and_answer` を呼び出す
  - `rag.ingest_markdown`：API Gateway の `/ingest_markdown` を呼び出す
- 各ツールのパラメータとして、少なくとも以下が指定できること
  - `question`（search_and_answer 用）
  - `markdown_path` または `markdown_text`（ingest_markdown 用、実装に合わせる）

### 4. Git リポジトリ / Markdown
- RAG 対象の Markdown ファイルを Git リポジトリに格納していること
  - 例：`docs/システム構成.md`
- 疎通確認用として、
  - 「このシステムの UI は Cursor である」
  - 「API Gateway を経由して Lambda を呼び出す」
  といった明確な記述を 1 つ以上入れておく

## 疎通確認手順（API Gateway 経由の Smoke Test）

### Step 0：全体の想定フローの確認
- Cursor → MCP → API Gateway → Lambda → OpenAI(Vector Store / Chat) → Lambda → API Gateway → Cursor
- 以降のテストは、この流れの各ポイントを順番に潰していくイメージで行う。

### Step 1：Lambda 単体の動作確認
1. AWS コンソールから、`search_and_answer` Lambda を開く
2. テストイベントを作成し、簡易な JSON を渡して実行できることを確認
   - 例：
     ```json
     {
       "question": "疎通確認のテストです。"
     }
     ```
3. 正常終了し、CloudWatch Logs にログが出力されていることを確認
4. 同様に `ingest_markdown` についてもテスト
   - 例：
     ```json
     {
       "markdown_text": "# 疎通テスト\nこれはテスト用の Markdown です。"
     }
     ```

※ この時点では OpenAI / Vector Store 連携まで含めてもよいが、まずは Lambda がエラー無く動くことを優先して確認する。

### Step 2：API Gateway → Lambda の疎通確認
1. API Gateway のコンソールから、`/search_and_answer` の URL を確認
2. ローカル端末から `curl` などで HTTP リクエストを投げる
   - 例：
     ```bash
     curl -X POST "https://{api-id}.execute-api.{region}.amazonaws.com/{stage}/search_and_answer" \
       -H "Content-Type: application/json" \
       -d '{
         "question": "API Gateway 経由の疎通テストです。"
       }'
     ```
3. 2xx のレスポンスが返り、Lambda 側のログにもリクエストが到達していることを確認
4. 同様に `/ingest_markdown` についてもテスト
   - 例：
     ```bash
     curl -X POST "https://{api-id}.execute-api.{region}.amazonaws.com/{stage}/ingest_markdown" \
       -H "Content-Type: application/json" \
       -d '{
         "markdown_text": "# 疎通テスト\nAPI Gateway 経由の ingest テストです。"
       }'
     ```

### Step 3：Vector Store との連携確認（バックエンド完結テスト）
1. `/ingest_markdown` エンドポイントに対して、実際の Markdown テキスト（またはファイル内容）を送信し、Vector Store に登録されるようにする
2. 続けて `/search_and_answer` に対し、先ほどの Markdown の内容に依存した質問を送信
   - 例：
     ```bash
     curl -X POST "https://{api-id}.execute-api.{region}.amazonaws.com/{stage}/search_and_answer" \
       -H "Content-Type: application/json" \
       -d '{
         "question": "このシステムの UI は何ですか？"
       }'
     ```
3. レスポンスの本文に「UI は Cursor」等、Markdown の内容に基づいた回答が含まれていれば、
   - Lambda → OpenAI(Vector Store + Chat) の流れが疎通していると判断できる。

### Step 4：Cursor（MCP）からのエンドツーエンド疎通確認
1. Cursor 上で MCP ツール `rag.ingest_markdown` を呼び出し、Git リポジトリ内の Markdown を指定して実行
   - 例：
     - `markdown_path: "docs/システム構成.md"`
2. 正常終了することを確認（必要であれば Lambda / API Gateway のログも確認）
3. 同じく Cursor から `rag.search_and_answer` を呼び出し、質問を送信
   - 例：
     - `question: "このシステムの UI は何ですか？"`
4. Cursor の回答として、Markdown に記載した内容を元にした自然な文章が返ってくることを確認

### Step 5：疎通テストの合否判定基準

| 検証ポイント | 成功条件 |
|--------------|----------|
| Lambda 単体 | コンソールからのテストイベントでエラーなく実行できる |
| API Gateway → Lambda | `curl` 等で 2xx レスポンスが返り、Lambda ログにリクエストが記録されている |
| Lambda → OpenAI / Vector Store | Markdown の内容に依存した質問に対して、内容に沿った回答が返る |
| Cursor（MCP）→ API Gateway | Cursor からツール呼び出しを行い、API Gateway 経由で Lambda が動作する |
| エンドツーエンド | 「Markdown を ingest してから、同じ内容を質問する」一連の流れが Cursor から完結する |

この Step 5 まで問題なく通れば、API Gateway を含む RAG システム全体の疎通確認が完了したとみなせる。
